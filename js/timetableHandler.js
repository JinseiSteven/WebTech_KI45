const host = 'webtech-ki45.webtech-uva.nl';


const periodWeeks = [
    [
    {
        "PeriodName": "Week 36",
        "DateFrom" : "2023-09-05",
        "DateTo" : "2023-09-9",
    },
    {
        "PeriodName": "Week 37",
        "DateFrom" : "2023-09-12",
        "DateTo" : "2023-09-16",

    },
    {
        "PeriodName": "Week 38",
        "DateFrom" : "2023-09-19",
        "DateTo" : "2023-09-23",
    },
    {
        "PeriodName": "Week 39",
        "DateFrom" : "2023-09-26",
        "DateTo" : "2023-09-30",
    },
    {
        "PeriodName": "Week 40",
        "DateFrom" : "2023-10-03",
        "DateTo" : "2023-10-07",
    },
    {
        "PeriodName": "Week 41",
        "DateFrom" : "2023-10-10",
        "DateTo" : "2023-10-14",
    },
    {
        "PeriodName": "Week 42",
        "DateFrom" : "2023-10-17",
        "DateTo" : "2023-10-21",
    },
    {
        "PeriodName": "Week 43",
        "DateFrom" : "2023-10-24",
        "DateTo" : "2023-10-28",
    }],
    [{
        "PeriodName": "Week 44",
        "DateFrom" : "2023-10-31",
        "DateTo" : "2023-11-04",
    },
    {
        "PeriodName": "Week 45",
        "DateFrom" : "2023-11-07",
        "DateTo" : "2023-11-11",
    },
    {
        "PeriodName": "Week 46",
        "DateFrom" : "2023-11-14",
        "DateTo" : "2023-11-18",
    },
    {
        "PeriodName": "Week 47",
        "DateFrom" : "2023-11-21",
        "DateTo" : "2023-11-25",
    },
    {
        "PeriodName": "Week 48",
        "DateFrom" : "2023-11-28",
        "DateTo" : "2023-12-02",
    },
    {
        "PeriodName": "Week 49",
        "DateFrom" : "2023-12-05",
        "DateTo" : "2023-12-09",
    },
    {
        "PeriodName": "Week 50",
        "DateFrom" : "2023-12-12",
        "DateTo" : "2023-12-16",
    },
    {
        "PeriodName": "Week 51",
        "DateFrom" : "2023-12-19",
        "DateTo" : "2023-12-23",
    }],
    [{
        "PeriodName": "Week 2",
        "DateFrom" : "2023-01-09",
        "DateTo" : "2023-01-13",
    },
    {
        "PeriodName": "Week 3",
        "DateFrom" : "2023-01-16",
        "DateTo" : "2023-01-20",
    },
    {
        "PeriodName": "Week 4",
        "DateFrom" : "2023-01-23",
        "DateTo" : "2023-01-27",
    },
    {
        "PeriodName": "Week 5",
        "DateFrom" : "2023-01-30",
        "DateTo" : "2023-02-03",
    }],
    [{
        "PeriodName": "Week 6",
        "DateFrom" : "2023-02-06",
        "DateTo" : "2023-02-10",
    },
    {
        "PeriodName": "Week 7",
        "DateFrom" : "2023-02-13",
        "DateTo" : "2023-02-17",
    },
    {
        "PeriodName": "Week 8",
        "DateFrom" : "2023-02-20",
        "DateTo" : "2023-02-24",
    },
    {
        "PeriodName": "Week 9",
        "DateFrom" : "2023-02-27",
        "DateTo" : "2023-03-03",
    },
    {
        "PeriodName": "Week 10",
        "DateFrom" : "2023-03-06",
        "DateTo" : "2023-03-10",
    },
    {
        "PeriodName": "Week 11",
        "DateFrom" : "2023-03-13",
        "DateTo" : "2023-03-17",
    },
    {
        "PeriodName": "Week 12",
        "DateFrom" : "2023-03-20",
        "DateTo" : "2023-03-24",
    },
    {
        "PeriodName": "Week 13",
        "DateFrom" : "2023-03-27",
        "DateTo" : "2023-03-31",
    }],
    [{
        "PeriodName": "Week 14",
        "DateFrom" : "2023-04-03",
        "DateTo" : "2023-04-07",
    },

    {
        "PeriodName": "Week 15",
        "DateFrom" : "2023-04-10",
        "DateTo" : "2023-04-14",
    },
    {
        "PeriodName": "Week 16",
        "DateFrom" : "2023-04-17",
        "DateTo" : "2023-04-21",
    },
    {
        "PeriodName": "Week 17",
        "DateFrom" : "2023-04-24",
        "DateTo" : "2023-04-28",
    },
    {
        "PeriodName": "Week 18",
        "DateFrom" : "2023-05-01",
        "DateTo" : "2023-05-05",
    },
    {
        "PeriodName": "Week 19",
        "DateFrom" : "2023-05-08",
        "DateTo" : "2023-05-12",
    },
    {
        "PeriodName": "Week 20",
        "DateFrom" : "2023-05-15",
        "DateTo" : "2023-05-19",
    },
    {
        "PeriodName": "Week 21",
        "DateFrom" : "2023-05-22",
        "DateTo" : "2023-05-26",
    },
    {
        "PeriodName": "Week 22",
        "DateFrom" : "2023-05-29",
        "DateTo" : "2023-06-02",
    }],
[{
        "PeriodName": "Week 23",
        "DateFrom" : "2023-06-05",
        "DateTo" : "2023-06-09",
    },
    {
        "PeriodName": "Week 24",
        "DateFrom" : "2023-06-12",
        "DateTo" : "2023-06-16",
    },
    {
        "PeriodName": "Week 25",
        "DateFrom" : "2023-06-19",
        "DateTo" : "2023-06-23",
    },
    {
        "PeriodName": "Week 26",
        "DateFrom" : "2023-06-26",
        "DateTo" : "2023-06",
    }]
]
const totalPeriods = 6;
var periodIndex = 0;

const changePeriod = (type) => {
    if(type == 'prev' && periodIndex === 0) return;
    else if(type == 'next' && periodIndex === totalPeriods - 1) return;
    else if(type == 'prev') periodIndex--;
    else if(type == 'load') periodIndex = 0;
    else  periodIndex++;
    let content =``;
   
    for(let i = 0; i < periodWeeks[periodIndex].length; i++){
        content += `<div class="week" onclick="fetchTimetable(1, '${periodWeeks[periodIndex][i].DateFrom}', '${periodWeeks[periodIndex][i].DateTo}')">
            ${periodWeeks[periodIndex][i].PeriodName}
        </div>`;
        
    }
    let periodContent = document.getElementsByClassName('period-content')[0];
    periodContent.innerHTML = content;

    //give the first week in the period the active class
    document.getElementsByClassName('week')[0].classList.add('active-week');

    //change counter
    let counter = document.getElementById('period-counter');
    let indicator = document.getElementById('period-indicator');
    indicator.innerHTML = `Period ${periodIndex + 1} of ${totalPeriods}`
    counter.innerHTML = `Period (${periodIndex + 1}/${totalPeriods})`;
    addClickHandlers();
}

const addClickHandlers = () => {
    document.querySelectorAll('.week').forEach((item) => {
        item.addEventListener('click', (e) => {
            document.getElementsByClassName('active-week')[0].classList.remove('active-week');
            e.target.classList.add('active-week');
            
        });
    })
}

const updateDates = (beginDate, endDate) => {
    let beginDay = beginDate.split('-')[2];
    let dates = document.querySelectorAll('#date')
    for(let i = 0; i < dates.length; i++){
        if(beginDate > 31) beginDay = 1;
        dates[i].innerHTML = `${beginDay}/${beginDate.split('-')[1]}`;

        var rows = document.querySelectorAll('tr');
        for(let j = 1; j < rows.length; j++){
            let row = rows[j];
            let cells = row.querySelectorAll('td');
            cells[i].setAttribute('data-date', `${beginDate.split('-')[0]}-${beginDate.split('-')[1]}-${String(beginDay).length == 1 ? '0' + beginDay : beginDay}`);

        }
        beginDay++;
    }

    //clear all cells
    document.querySelectorAll('td').forEach((td) => {
        td.innerHTML = '';
    });

    //update header date
    let headerDate = document.getElementById('week-days-indicator');
    headerDate.innerHTML = `${beginDate.split('-')[2]}/${beginDate.split('-')[1]} - ${endDate.split('-')[2]}/${endDate.split('-')[1]}`;
}

// date format is YYYY-MM-DD
const fetchTimetable = async (userID, beginDate, endDate) => {
    updateDates(beginDate, endDate);
    url = `https://${host}/post-files/timetable-post.php?userID=${userID}&beginDate=${beginDate}&endDate=${endDate}`;
    const response = await fetch(url, {
        "headers": {
          "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
          "accept-language": "en-US,en;q=0.9,nl;q=0.8,fr;q=0.7",
          "cache-control": "no-cache",
          "pragma": "no-cache",
          "sec-ch-ua": "\"Not_A Brand\";v=\"99\", \"Google Chrome\";v=\"109\", \"Chromium\";v=\"109\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Windows\"",
          "sec-fetch-dest": "empty",
          "sec-fetch-mode": "cors",
          "sec-fetch-site": "same-origin",
          "upgrade-insecure-requests": "1"
        },
        "referrer": "http://localhost/WebTech_KI45/timetable.php",
        "referrerPolicy": "strict-origin-when-cross-origin",
        "body": null,
        "method": "GET",
        "mode": "cors",
        "credentials": "include"
      }); 
      // get body
        const body = await response.text();
        if(body === '') return;
        else{
            jsonData = JSON.parse(body);
            return loadCalendarItems(jsonData);
        }
}
const loadCalendarItems = (items) => {
    Nosifier.sucess(`Found ${items.length} courses this week!`);
   
    
    items.forEach((item) => {
        let possibleBoxes = document.querySelectorAll(`[data-date="${item.seminarDate}"]`);
        for(let i = 0; i < possibleBoxes.length; i++){
           if(possibleBoxes[i].innerHTML.length <50){
                possibleBoxes[i].innerHTML = `<div class="flex--column course-box">
                    <span class="course-name">${item.className}</span>
                    <span class="course-location">${item.seminarType}, ${item.seminarLocation}</span>
                </div>`
                break;
           }
        }
    });
}



window.addEventListener('load', function () {
    changePeriod('load')
    addClickHandlers();
});